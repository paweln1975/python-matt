{% extends 'sudoku/base.html' %}
{% load sudoku_tags %}

{% block title %}
    {% if action == 'edit' %}Edycja łamigłówki #{{ puzzle.id }}{% else %}Nowa łamigłówka{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>
        {% if action == 'edit' %}
            Edycja łamigłówki #{{ puzzle.id }}
        {% else %}
            Nowa łamigłówka
        {% endif %}
    </h1>

    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}

                <div class="mb-3">
                    <label for="{{ form.difficulty.id_for_label }}" class="form-label">{{ form.difficulty.label }}</label>
                    {{ form.difficulty }}
                    {% if form.difficulty.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.difficulty.errors }}
                    </div>
                    {% endif %}
                </div>

                <div class="sudoku-grid">
                    {% for row in "012345678" %}
                        <div class="sudoku-row">
                            {% for col in "012345678" %}
                                <div class="sudoku-cell">
                                    {% with cell_name="cell_"|add:row|add:"_"|add:col %}
                                    {{ form|getattr:cell_name }}
                                    {% endwith %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>

                <div class="mt-4 d-flex gap-2">
    <button type="submit" class="btn btn-primary">
        {% if action == 'edit' %}Zapisz zmiany{% else %}Utwórz{% endif %}
    </button>
    {% if action == 'edit' %}
        <a href="{% url 'sudoku:puzzle_generate_solution' puzzle.id %}"
           class="btn btn-info"
           onclick="event.preventDefault(); document.getElementById('generate-solution-form').submit();">
            Generuj rozwiązanie
        </a>
        <a href="{% url 'sudoku:puzzle_detail' puzzle.id %}" class="btn btn-secondary">Anuluj</a>
    {% else %}
        <a href="{% url 'sudoku:puzzle_list' %}" class="btn btn-secondary">Anuluj</a>
    {% endif %}
</div>


            </form>
        {% if action == 'edit' and puzzle.solution %}
<div class="mt-4">
    <h4>Aktualne rozwiązanie:</h4>
    <div class="sudoku-grid">
        {% with solution=puzzle.get_solution %}
            {% for row in solution %}
                <div class="sudoku-row">
                    {% for cell in row %}
                        <div class="sudoku-cell">
                            <input type="text" class="sudoku-cell" readonly value="{{ cell }}" style="background-color: #f8f9fa;">
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% endwith %}
    </div>
</div>
{% endif %}

        </div>
    </div>
{% if action == 'edit' %}
<form id="generate-solution-form" method="post" action="{% url 'sudoku:puzzle_generate_solution' puzzle.id %}" style="display: none;">
    {% csrf_token %}
</form>
{% endif %}

</div>

<style>
.sudoku-grid {
    display: grid;
    grid-template-rows: repeat(9, 1fr);
    gap: 1px;
    background-color: #ccc;
    padding: 2px;
    width: fit-content;
    margin: 0 auto;
}

.sudoku-row {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 1px;
}

.sudoku-cell {
    background-color: white;
    padding: 2px;
}

.sudoku-cell input {
    width: 40px;
    height: 40px;
    text-align: center;
    border: 1px solid #ddd;
    font-size: 20px;
    padding: 0;
}

.sudoku-cell input:focus {
    outline: 2px solid #007bff;
}

/* Pogrubione linie dla kwadratów 3x3 */
.sudoku-row:nth-child(3n) {
    border-bottom: 2px solid #333;
}

.sudoku-cell:nth-child(3n) {
    border-right: 2px solid #333;
}

/* Style dla selecta difficulty */
select.form-select {
    width: auto;
    display: block;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('.sudoku-cell input');

    inputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = this.value;
            if (value.length > 1) {
                this.value = value.slice(0, 1);
            }
            if (value !== '' && (isNaN(value) || value < 0 || value > 9)) {
                this.value = '';
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key >= '0' && e.key <= '9' || e.key === 'Tab') {
                const allInputs = Array.from(document.querySelectorAll('.sudoku-cell input'));
                const currentIndex = allInputs.indexOf(this);

                if (e.key !== 'Tab') {
                    // Dla liczb, poczekaj na wprowadzenie wartości
                    setTimeout(() => {
                        let nextInput;
                        for (let i = currentIndex + 1; i < allInputs.length; i++) {
                            if (!allInputs[i].readOnly) {
                                nextInput = allInputs[i];
                                break;
                            }
                        }
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }, 0);
                } else if (!e.shiftKey) {
                    // Dla klawisza Tab
                    e.preventDefault();
                    let nextInput;
                    for (let i = currentIndex + 1; i < allInputs.length; i++) {
                        if (!allInputs[i].readOnly) {
                            nextInput = allInputs[i];
                            break;
                        }
                    }
                    if (nextInput) {
                        nextInput.focus();
                    }
                } else {
                    // Dla Shift+Tab
                    e.preventDefault();
                    let previousInput;
                    for (let i = currentIndex - 1; i >= 0; i--) {
                        if (!allInputs[i].readOnly) {
                            previousInput = allInputs[i];
                            break;
                        }
                    }
                    if (previousInput) {
                        previousInput.focus();
                    }
                }
            }
        });
    });
});
</script>

{% endblock %}
